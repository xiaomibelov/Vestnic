name: ci-schema-guard

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  schema-guard:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker info
        run: |
          docker version
          docker compose version

      - name: Compose up db/redis
        run: |
          docker compose up -d db redis
          docker compose ps

      - name: Build worker
        run: |
          docker compose build worker

      - name: Schema init + check (must be ok)
        run: |
          docker compose run --rm worker python -m vestnik.schema init
          docker compose run --rm worker python -m vestnik.schema check

      - name: Worker oneshot (noschema runtime)
        run: |
          docker compose run --rm -e VESTNIK_SCHEMA_AUTO=0 worker python -m vestnik.worker oneshot

      - name: Compose logs (on failure)
        if: failure()
        run: |
          docker compose ps || true
          docker compose logs --no-color --tail=400 db || true
          docker compose logs --no-color --tail=400 redis || true

      - name: Compose down
        if: always()
        run: |
          docker compose down -v || true
