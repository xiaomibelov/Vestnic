from __future__ import annotations

import json
from datetime import datetime

from vestnik.brain.openai_http import chat_completions
from vestnik.brain.stage1 import Stage1Item


_SYSTEM = (
    "–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –º–æ–¥—É–ª—å ¬´–ß–∏—Å—Ç—ã–π –≤–µ—Å—Ç–Ω–∏–∫¬ª.\n"
    "–°—Ç–∏–ª—å: —Å—Ç–µ—Ä–∏–ª—å–Ω—ã–π, —Å–ø–æ–∫–æ–π–Ω—ã–π, –±–µ–∑ –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å—É–∂–¥–µ–Ω–∏–π.\n"
    "–ó–∞–ø—Ä–µ—Ç: –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –¥–æ–¥—É–º—ã–≤–∞—Ç—å —Ñ–∞–∫—Ç—ã. –¢–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –µ—Å—Ç—å –≤–æ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.\n"
    "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <= 4096 —Å–∏–º–≤–æ–ª–æ–≤.\n"
    "–§–æ—Ä–º–∞—Ç: —Å—Ç—Ä–æ–≥–æ –ø–æ —à–∞–±–ª–æ–Ω—É –Ω–∏–∂–µ. –°—Å—ã–ª–∫–∏ ‚Äî –≤ —è–≤–Ω–æ–º –≤–∏–¥–µ (URL), —á—Ç–æ–±—ã Telegram –¥–µ–ª–∞–ª –∏—Ö –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏."
)


_TEMPLATE = (
    "üìÖ –ß–ò–°–¢–ê–Ø –°–í–û–î–ö–ê: {PACK_NAME}\n"
    "–ü–µ—Ä–∏–æ–¥: {START} ‚Äî {END}\n"
    "–ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤: {COUNT}\n"
    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    "üî• –§–ê–ö–¢–´ –ò –°–û–ë–´–¢–ò–Ø\n"
    "(—Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è)\n\n"
    "‚Ä¢ {TITLE_NEUTRAL}\n"
    "{DESCRIPTION}\n"
    "üîó {SOURCES}\n\n"
    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    "üìà –¢–†–ï–ù–î–´\n"
    "(–∑–Ω–∞—á–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏)\n\n"
    "‚ñ™Ô∏è {TREND_NAME}: {DESC}\n"
    "üîó {SOURCE}\n\n"
    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    "‚ö°Ô∏è –°–ò–ì–ù–ê–õ–´\n"
    "(–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–≥—Ä–æ–∑—ã/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)\n\n"
    "‚Ä∫ {INSIGHT}\n"
    "üîó {SOURCE}\n\n"
    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    "üìä –°–ò–ù–¢–ï–ó\n"
    "{ANALYTICS}\n"
    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    "üè∑ #–ß–∏—Å—Ç—ã–π–í–µ—Å—Ç–Ω–∏–∫ #{TAG}\n"
    "‚è∞ –°–ª–µ–¥—É—é—â–∞—è —Å–≤–æ–¥–∫–∞: {NEXT_TIME}\n"
)


def _fmt_dt(dt: datetime) -> str:
    return dt.strftime("%Y-%m-%d %H:%M")


async def run_stage2(
    model: str,
    pack_name: str,
    start: datetime,
    end: datetime,
    items: list[Stage1Item],
) -> str:
    payload = {
        "pack_name": pack_name,
        "period_start": _fmt_dt(start),
        "period_end": _fmt_dt(end),
        "items": [{"summary": i.summary, "url": i.url, "channel_name": i.channel_name} for i in items],
        "required_template": _TEMPLATE,
    }

    user = (
        "–°–æ–±–µ—Ä–∏ –æ—Ç—á—ë—Ç –ø–æ —à–∞–±–ª–æ–Ω—É. –í –∫–∞—á–µ—Å—Ç–≤–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π URL –∏–∑ items.\n"
        "–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON):\n"
        + json.dumps(payload, ensure_ascii=False)
    )

    text = await chat_completions(model=model, system=_SYSTEM, user=user, temperature=0.2)
    text = text.strip()

    if len(text) <= 4096:
        return text

    shrink_user = (
        "–°–æ–∫—Ä–∞—Ç–∏ —Ç–µ–∫—Å—Ç –¥–æ <= 4096 —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ñ–∞–∫—Ç–æ–≤ –∏ –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö.\n"
        "–°–æ—Ö—Ä–∞–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ —Å—Å—ã–ª–∫–∏.\n\n"
        + text
    )
    shrunk = await chat_completions(model=model, system=_SYSTEM, user=shrink_user, temperature=0.2)
    return shrunk.strip()[:4096]
